name: Sync Cin7 Orders to InPost

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Run this workflow on a schedule (e.g., every 5 minutes)
  schedule:
    # Cron syntax: "Minute Hour DayOfMonth Month DayOfWeek"
    # This example runs every 5 minutes
    - cron: '*/5 * * * *'
    # Example for daily at 2 AM UTC: '0 2 * * *'
    # Example for hourly: '0 * * * *'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "sync"
  sync:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Important: Persist credentials to allow pushing changes back
          token: ${{ secrets.GITHUB_TOKEN }}

      # Sets up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5 # Use the latest stable version
        with:
          python-version: '3.10' # Specify your required Python version

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Run the synchronization script
      - name: Run Sync Script
        env:
          CIN7_CORE_ACCOUNT_ID: ${{ secrets.CIN7_CORE_ACCOUNT_ID }}
          CIN7_CORE_APP_KEY: ${{ secrets.CIN7_CORE_APP_KEY }}
          INPOST_API_KEY: ${{ secrets.INPOST_API_KEY }}
          INPOST_DEPOT_ID: ${{ secrets.INPOST_DEPOT_ID }} # If you added it as a secret
          # Add other env vars if needed
        run: |
          complete_flow_inpost_core.py # Replace with your actual script name

      # (Optional) Commit and push updated state files, dont try this yet
      # This preserves the processed_orders.json and synced_orders.json between runs
      - name: Commit and push updated state files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Check if relevant files have changed
          git diff --quiet processed_orders.json synced_orders.json || (git add processed_orders.json synced_orders.json && git commit -m "Update processed/synced order state [skip ci]" && git push)
        # Continue if committing/pushing fails (e.g., no changes)
        continue-on-error: true
